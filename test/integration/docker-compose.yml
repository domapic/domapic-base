version: "3.5"
volumes:
  domapic_config:
services:
  test:
    build:
      context: ./test
      args:
        - test_to_run=${test_to_run}
    depends_on:
      - service
    volumes:
      - type: volume
        source: domapic_config
        target: /test/config
        volume:
          nocopy: true
      - type: bind
        source: ../../node_modules
        target: /test/node_modules
      - type: bind
        source: ../../test/unit
        target: /test/test/unit
  service:
    build:
      context: ./service
      args:
        - service_to_start=${service_to_start}
    # Uncomment ports for tests development and debugging
    # ports: 
     # - 5000:3000
    volumes:
      - type: volume
        source: domapic_config
        target: /service/config
        volume:
          nocopy: true
      - type: bind
        source: ../../node_modules
        target: /service/node_modules
      - type: bind
        source: ../../lib
        target: /service/lib
      - type: bind
        source: ../../index.js
        target: /service/index.js
    env_file:
      - ./commands/${command_to_use}.env
      - ./options/${options_to_use}.env
